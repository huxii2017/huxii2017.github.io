<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>BetaBionmial-BayesInfer-TCR-2017-NatGen</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../../css/github-plus.css" />
  <link rel="stylesheet" href="../../css/code-theme.css" />
  <link rel="stylesheet" href="../../css/github-markdown.css" />
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <base target="_blank">
</head>
<body>
<h1 id="reproducing-the-statistical-learning-framework-of-emerson-et-al.-nature-genetics-2017">Reproducing the Statistical Learning Framework of Emerson <em>et al.</em>, <em>Nature Genetics</em> (2017)</h1>
<details open>
<summary>
<b>üóÇÔ∏è Table of Contents</b>
</summary>
<ol type="1">
<li><a href="#introduction">Method Overview and Reported Performance (Paper Example)</a></li>
<li><a href="#statistic">Statistical Learning Framework and Key Concepts</a></li>
<li><a href="#Implementation">Implementation in both R and Python</a></li>
</ol>
</details>
<p>This note aims to reproduce the statistical learning approach introduced in <a href="https://www.nature.com/articles/ng.3822"><strong>Emerson <em>et al.</em>, <em>Nature Genetics</em>, 2017</strong></a>, which classified cytomegalovirus (CMV) infection status based on <strong>T cell receptor beta-chain (TCRŒ≤) repertoires</strong>.<br />
The original work proposed a generative model that integrates phenotype-associated TCR selection, Beta‚ÄìBinomial modeling, and Bayesian inference to predict individual phenotypes from repertoire data.<br />
The classifier belongs to the family of <strong>statistical learning</strong> and <strong>generative models</strong>, and its key advantage lies in effectively incorporating sampling depth information and the binary presence/absence state of each TCRŒ≤ sequence.</p>
<p>Although the original paper achieved high predictive performance (AUROC ‚âà 0.94; sensitivity and specificity ‚âà 0.9), <strong>no source code was released</strong> by the authors.</p>
<p><strong>Data availability:</strong><br />
The TCRŒ≤ repertoire data used in this study were published by <strong>Adaptive Biotechnologies</strong> on the <a href="https://clients.adaptivebiotech.com/pub/emerson-2017-natgen">immuneACCESS‚Ñ¢ platform</a>.<br />
While certain functionalities of the <em>immunoSEQ Analyzer</em> require a registered account, the core data are available for direct download via the public link.<br />
This note reconstructs the statistical screening and generative modeling framework <strong>entirely from the methodological descriptions in the paper</strong>,<br />
without relying on <em>immuneML</em> or the <em>immunoSEQ Analyzer</em> environment.</p>
<hr />
<h2 id="introduction">1. Method Overview and Reported Performance (Paper Example)</h2>
<p><strong>Task:</strong><br />
Predict whether an individual is <strong>CMV-positive (CMV‚Å∫)</strong> based on their TCRŒ≤ repertoire.</p>
<p><strong>Strategy:</strong><br />
1. <strong>Statistical screening of public TCRŒ≤ sequences:</strong><br />
In the training set, each TCRŒ≤ sequence is evaluated for its association with the phenotype using <strong>Fisher‚Äôs exact test</strong>. Significantly associated TCRs are selected based on a <em>P</em>-value threshold optimized through cross-validation (final threshold ‚âà 1√ó10‚Åª‚Å¥).</p>
<ol start="2" type="1">
<li><p><strong>Phenotype burden modeling:</strong><br />
For each subject, the <strong>phenotype burden</strong> is defined as the number of phenotype-associated TCRŒ≤ sequences detected in their repertoire.<br />
This burden is then modeled separately for CMV‚Å∫ and CMV‚Åª groups using a <strong>Beta‚ÄìBinomial</strong> distribution to capture variation due to sampling depth.</p></li>
<li><p><strong>Generative Bayesian classification:</strong><br />
Based on the Beta‚ÄìBinomial likelihood functions and class priors for both phenotypes, the posterior probability of being CMV‚Å∫ or CMV‚Åª is computed.<br />
The phenotype with the higher posterior probability is assigned using the <strong>Maximum A Posteriori (MAP)</strong> decision rule.</p></li>
</ol>
<p><strong>Reported performance:</strong><br />
The original study achieved strong predictive power: AUROC ‚âà <strong>0.99</strong> on the all training set, cross-validation AUROC ‚âà <strong>0.93</strong> on the training set and AUROC ‚âà <strong>0.94</strong> on the independent validation set, with <strong>specificity and sensitivity around 0.89‚Äì0.90</strong>.</p>
<hr />
<h2 id="statistic">2. Statistical Learning Framework and Key Concepts</h2>
<h3 id="statistical-screening-fishers-exact-test">2.1 Statistical Screening (Fisher‚Äôs Exact Test)</h3>
<ul>
<li><p><strong>Input:</strong><br />
The training dataset consists of a binary <strong>presence/absence</strong> matrix of public TCRŒ≤ sequences<br />
(whether each sequence is observed in each subject) and the corresponding phenotype labels (CMV‚Å∫ / CMV‚Åª).</p></li>
<li><p><strong>Contingency table:</strong><br />
For each TCRŒ≤, construct a <span class="math inline">\(2\times2\)</span> contingency table:</p>
<p><span class="math display">\[
\begin{array}{c|cc}
&amp; \text{Phenotype +} &amp; \text{Phenotype ‚Äì} \\\hline
\text{TCR present} &amp; a &amp; b \\
\text{TCR absent}  &amp; c &amp; d
\end{array}
\]</span></p>
<p>and compute the <em>P</em>-value using <strong>Fisher‚Äôs exact test</strong>.</p></li>
<li><p><strong>Threshold selection:</strong><br />
Evaluate different <span class="math inline">\(p_{\text{thr}}\)</span> thresholds (e.g., from <span class="math inline">\(10^{-2}\)</span> to <span class="math inline">\(10^{-6}\)</span>) using <strong>leave-one-out cross-validation (LOOCV)</strong> or <em>k</em>-fold CV to assess the downstream AUROC performance.<br />
The optimal threshold is selected by maximizing AUROC; in the paper, the final threshold was approximately <span class="math inline">\(1\times10^{-4}\)</span>.</p></li>
</ul>
<h3 id="phenotype-burden-and-the-betabinomial-generative-model">2.2 Phenotype Burden and the Beta‚ÄìBinomial Generative Model</h3>
<ul>
<li><p><strong>Definition:</strong><br />
For each sample <span class="math inline">\(i\)</span>, let the set of phenotype-associated TCRs identified in screening be <span class="math inline">\(\mathcal{S}\)</span>.<br />
Define</p>
<ul>
<li><span class="math inline">\(k_i = \sum_{t \in \mathcal{S}} \mathbf{1}\{\text{sample } i \text{ contains TCR } t\}\)</span> ‚Äî the number of associated TCRŒ≤ sequences in sample <span class="math inline">\(i\)</span>;<br />
</li>
<li><span class="math inline">\(n_i\)</span> ‚Äî the total number of unique TCRŒ≤ sequences (or total public TCRŒ≤s observed) in sample <span class="math inline">\(i\)</span>, defined consistently across all samples.</li>
</ul></li>
<li><p><strong>Model:</strong><br />
For each phenotype class <span class="math inline">\(y \in \{\text{CMV}^+, \text{CMV}^-\}\)</span>, assume</p>
<p><span class="math display">\[
k_i \mid n_i, p_y \sim \mathrm{Binomial}(n_i, p_y), \quad
p_y \sim \mathrm{Beta}(\alpha_y, \beta_y).
\]</span></p>
<p>The marginal likelihood of <span class="math inline">\(k_i\)</span> follows the <strong>Beta‚ÄìBinomial</strong> distribution:</p>
<p><span class="math display">\[
\Pr(k_i \mid n_i, \alpha_y, \beta_y)
= \binom{n_i}{k_i}
\frac{B(k_i + \alpha_y,\; n_i - k_i + \beta_y)}{B(\alpha_y, \beta_y)}.
\]</span></p>
<p>This generative model preserves information about sampling depth <span class="math inline">\(n_i\)</span> and avoids biases from proportion-based normalization.</p></li>
<li><p><strong>Parameter estimation:</strong><br />
Parameters <span class="math inline">\((\alpha_y, \beta_y)\)</span> are estimated for each class using <strong>maximum likelihood estimation (MLE)</strong> or the <strong>method of moments</strong> based on the observed <span class="math inline">\((k_i, n_i)\)</span> pairs in the training data.</p></li>
</ul>
<h3 id="bayesian-classification-map">2.3 Bayesian Classification (MAP)</h3>
<ul>
<li><p>Given the class prior <span class="math inline">\(\pi_y\)</span> (either sample frequency or uniform <span class="math inline">\(0.5/0.5\)</span>), compute for each test sample <span class="math inline">\(i\)</span>:</p>
<p><span class="math display">\[
\log \Pr(y \mid k_i, n_i)
\propto
\log \Pr(k_i \mid n_i, \alpha_y, \beta_y)
+ \log \pi_y.
\]</span></p>
<p>The phenotype with the highest posterior probability is chosen according to the <strong>Maximum A Posteriori (MAP)</strong> rule.</p></li>
</ul>
<h3 id="cross-validation-and-performance-evaluation">2.4 Cross-Validation and Performance Evaluation</h3>
<ul>
<li><p><strong>LOOCV procedure:</strong></p>
<ol type="1">
<li>Leave one sample out from the dataset.<br />
</li>
<li>Perform feature screening and model fitting on the remaining samples.<br />
</li>
<li>Use the trained parameters <span class="math inline">\((\alpha_y, \beta_y)\)</span> and TCR set <span class="math inline">\(\mathcal{S}\)</span> to predict the left-out sample‚Äôs phenotype.<br />
</li>
<li>Repeat for all samples, then aggregate performance metrics.</li>
</ol></li>
<li><p><strong>Performance metrics:</strong><br />
The main metric is <strong>AUROC</strong>. Sensitivity (<span class="math inline">\(\text{sens}\)</span>), specificity (<span class="math inline">\(\text{spec}\)</span>), and<br />
<strong>diagnostic odds ratio (DOR)</strong> are also reported:</p>
<p><span class="math display">\[
\mathrm{DOR} = \frac{\mathrm{TP}/\mathrm{FN}}{\mathrm{FP}/\mathrm{TN}}.
\]</span></p>
<p>According to the paper and independent reproductions, the model achieved AUROC ‚âà 0.93‚Äì0.94 and <span class="math inline">\(\text{sens/spec} ‚âà 0.88\)</span>‚Äì<span class="math inline">\(0.90\)</span>.</p></li>
</ul>
<h2 id="Implementation">3. Implementation in both R and Python:</h2>
<h3 id="step-1-fishers-exact-test">Step 1 ‚Äî Fisher‚Äôs Exact Test</h3>
<p>In this step, we perform <strong>statistical screening</strong> of public TCRŒ≤ sequences to identify those significantly associated with the phenotype (CMV‚Å∫ vs.¬†CMV‚Åª).<br />
Here we assume that the <strong>bioinformatics preprocessing</strong> (such as alignment, clonotype collapsing, and counting) has already been completed.<br />
Thus, the input is a simple three-column table summarizing the presence of each TCRŒ≤ sequence in positive and negative cohorts.</p>
<hr />
<h4 id="input-data-format">Input data format</h4>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Column</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>aaSeq</code></td>
<td style="text-align: left;">Amino acid sequence of the TCRŒ≤ CDR3 region</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>neg</code></td>
<td style="text-align: left;">Number of CMV‚Åª individuals in which this sequence appears</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>pos</code></td>
<td style="text-align: left;">Number of CMV‚Å∫ individuals in which this sequence appears</td>
</tr>
</tbody>
</table>
<p>Example snippet (<code>input.tsv</code> w/o header):</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">aaSeq</th>
<th style="text-align: left;">neg</th>
<th style="text-align: left;">pos</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CASSPGQETQYF</td>
<td style="text-align: left;">12</td>
<td style="text-align: left;">45</td>
</tr>
<tr class="even">
<td style="text-align: left;">CASSLGQNTIYF</td>
<td style="text-align: left;">5</td>
<td style="text-align: left;">38</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CASSLGTDTQYF</td>
<td style="text-align: left;">22</td>
<td style="text-align: left;">17</td>
</tr>
</tbody>
</table>
<p>‚Ä¶</p>
<p>Number of individuals in each phenotype group (from the Emerson 2017 dataset):<br />
- <strong>CMV‚Å∫:</strong> 289 subjects<br />
- <strong>CMV‚Åª:</strong> 351 subjects</p>
<hr />
<h4 id="python-implementation">Python implementation</h4>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fisher_exact_test.py</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform Fisher&#39;s exact test for each TCRŒ≤ sequence</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> fisher_exact</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># number of subjects in each phenotype group</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>tn <span class="op">=</span> <span class="dv">351</span>   <span class="co"># CMV‚Äì</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>tp <span class="op">=</span> <span class="dv">289</span>   <span class="co"># CMV+</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># read input data</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(sys.argv[<span class="dv">1</span>], sep<span class="op">=</span><span class="st">&#39;</span><span class="ch">\t</span><span class="st">&#39;</span>, header<span class="op">=</span><span class="va">None</span>, names<span class="op">=</span>[<span class="st">&#39;aaSeq&#39;</span>,<span class="st">&#39;neg&#39;</span>,<span class="st">&#39;pos&#39;</span>])</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># perform Fisher test for each sequence</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(sys.argv[<span class="dv">2</span>], <span class="st">&#39;wt&#39;</span>) <span class="im">as</span> out:</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> aa, n, p <span class="kw">in</span> <span class="bu">zip</span>(data[<span class="st">&#39;aaSeq&#39;</span>], data[<span class="st">&#39;neg&#39;</span>], data[<span class="st">&#39;pos&#39;</span>]):</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>        n, p <span class="op">=</span> <span class="bu">int</span>(n), <span class="bu">int</span>(p)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>        _, pvalue <span class="op">=</span> fisher_exact([[n, tn <span class="op">-</span> n], [p, tp <span class="op">-</span> p]])</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="sc">{aa}</span><span class="ch">\t</span><span class="sc">{n}</span><span class="ch">\t</span><span class="sc">{p}</span><span class="ch">\t</span><span class="sc">{</span>pvalue<span class="sc">}</span><span class="ss">&quot;</span>, <span class="bu">file</span><span class="op">=</span>out)</span></code></pre></div>
<hr />
<h4 id="r-implementation">R implementation</h4>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env Rscript</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># fisher_exact_test.R</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform Fisher&#39;s exact test for each TCRŒ≤ sequence</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>args <span class="ot">&lt;-</span> <span class="fu">commandArgs</span>(<span class="at">trailingOnly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>input_file  <span class="ot">&lt;-</span> args[<span class="dv">1</span>]</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>output_file <span class="ot">&lt;-</span> args[<span class="dv">2</span>]</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># number of individuals in each group</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>tn <span class="ot">&lt;-</span> <span class="dv">351</span>  <span class="co"># CMV‚Äì</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>tp <span class="ot">&lt;-</span> <span class="dv">289</span>  <span class="co"># CMV+</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read.table</span>(input_file, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>, <span class="at">header =</span> <span class="cn">FALSE</span>,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>                   <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">&quot;aaSeq&quot;</span>, <span class="st">&quot;neg&quot;</span>, <span class="st">&quot;pos&quot;</span>), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># compute Fisher exact test</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">apply</span>(data, <span class="dv">1</span>, <span class="cf">function</span>(row) {</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(row[<span class="st">&quot;neg&quot;</span>])</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(row[<span class="st">&quot;pos&quot;</span>])</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  test <span class="ot">&lt;-</span> <span class="fu">fisher.test</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(n, tn <span class="sc">-</span> n, p, tp <span class="sc">-</span> p), <span class="at">nrow =</span> <span class="dv">2</span>))</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="at">aaSeq =</span> row[<span class="st">&quot;aaSeq&quot;</span>], <span class="at">neg =</span> n, <span class="at">pos =</span> p, <span class="at">pvalue =</span> test<span class="sc">$</span>p.value)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">t</span>(results))</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(results, <span class="at">file =</span> output_file, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>, <span class="at">quote =</span> <span class="cn">FALSE</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<hr />
<p><strong>Usage example:</strong></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> fisher_exact_test.py input.tsv fisher_results.tsv <span class="co"># Python implementation</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Rscript</span> fisher_exact_test.R input.tsv fisher_results.tsv <span class="co"># R implementation</span></span></code></pre></div>
<p><strong>Output (fisher_results.tsv):</strong></p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">aaSeq</th>
<th style="text-align: left;">neg</th>
<th style="text-align: left;">pos</th>
<th style="text-align: left;">pvalue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CASSPGQETQYF</td>
<td style="text-align: left;">12</td>
<td style="text-align: left;">45</td>
<td style="text-align: left;">1.8e-05</td>
</tr>
<tr class="even">
<td style="text-align: left;">CASSLGQNTIYF</td>
<td style="text-align: left;">5</td>
<td style="text-align: left;">38</td>
<td style="text-align: left;">2.1e-07</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CASSLGTDTQYF</td>
<td style="text-align: left;">22</td>
<td style="text-align: left;">17</td>
<td style="text-align: left;">0.423</td>
</tr>
</tbody>
</table>
<p>‚Ä¶</p>
<p><strong>Interpretation</strong> * Each P-value quantifies the statistical association between a given TCRŒ≤ sequence and the CMV phenotype. * Sequences with <span class="math inline">\(p \le p_{\text{thr}}\)</span> (e.g., <span class="math inline">\(10^{-4}\)</span>) are considered phenotype-associated and retained for downstream modeling (Step 2: Beta‚ÄìBinomial generative model).</p>
<hr />
<h3 id="step-2-3-betabinomial-modeling-and-bayesian-classification">Step 2 &amp; 3 ‚Äî Beta‚ÄìBinomial Modeling and Bayesian Classification</h3>
<p>After statistical screening (Step 1), we summarize the data at the <strong>individual level</strong>. Each subject is represented by a row containing the total repertoire depth, the number of phenotype-associated TCRŒ≤ sequences detected, and the total number of unique clonotypes observed.</p>
<p>The processed data table contains <strong>five columns</strong>:</p>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Column</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>sample</code></td>
<td style="text-align: left;">Subject ID</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>group</code></td>
<td style="text-align: left;">Phenotype label (<code>HCMV+</code> or <code>HCMV‚Äì</code>)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>factor</code></td>
<td style="text-align: left;">Binary encoding of phenotype (<code>1</code> = HCMV‚Å∫, <code>0</code> = HCMV‚Åª)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>depth</code></td>
<td style="text-align: left;">Total number of unique TCRŒ≤ clonotypes observed (sampling depth)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>k</code></td>
<td style="text-align: left;">Number of TCRŒ≤ sequences that matched the CMV‚Å∫-associated list</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>n</code></td>
<td style="text-align: left;">Total number of TCRŒ≤ sequences (or total reads / clonotypes used for normalization)</td>
</tr>
</tbody>
</table>
<p>Example (<code>summary.tsv</code>): &lt;&gt;</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">sample</th>
<th style="text-align: left;">group</th>
<th style="text-align: left;">factor</th>
<th style="text-align: right;">depth</th>
<th style="text-align: right;">k</th>
<th style="text-align: right;">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">HIP00110</td>
<td style="text-align: left;">HCMV-</td>
<td style="text-align: left;">0</td>
<td style="text-align: right;">96659</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">104850</td>
</tr>
<tr class="even">
<td style="text-align: left;">HIP00169</td>
<td style="text-align: left;">HCMV-</td>
<td style="text-align: left;">0</td>
<td style="text-align: right;">90693</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">96869</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HIP00594</td>
<td style="text-align: left;">HCMV+</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">149386</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">161024</td>
</tr>
<tr class="even">
<td style="text-align: left;">‚Ä¶</td>
<td style="text-align: left;">‚Ä¶</td>
<td style="text-align: left;">‚Ä¶</td>
<td style="text-align: right;">‚Ä¶</td>
<td style="text-align: right;">‚Ä¶</td>
<td style="text-align: right;">‚Ä¶</td>
</tr>
</tbody>
</table>
<p>In the Emerson <em>et al.</em> study, two <strong>independent cohorts</strong> were included. Following the same design, we will use <strong>Cohort 1</strong> as the <strong>training set</strong> for model fitting and <strong>Cohort 2</strong> as the <strong>evaluation set</strong> for performance testing.</p>
<p>For reproducibility, the processed data required for these steps have already been prepared and can be directly downloaded as:</p>
<ul>
<li><a href="./HCMV_Train_Matrix_in_paper.tsv">HCMV_Train_Matrix_in_paper.tsv</a> ‚Äî training cohort used for parameter estimation<br />
</li>
<li><a href="./HCMV_Eval_Matrix_in_paper.tsv">HCMV_Eval_Matrix_in_paper.tsv</a> ‚Äî evaluation cohort used for model testing</li>
</ul>
<p><strong>Exploratory Visualization of Sample Features</strong></p>
<p>Before model fitting, we visualize the <strong>training</strong> and <strong>evaluation</strong> cohorts to examine how the number of total unique TCRŒ≤ sequences (<code>n</code>) relates to the number of CMV-associated TCRŒ≤ sequences (<code>k</code>).</p>
<p>Each dot represents one individual: - <strong>x-axis:</strong> total unique TCRŒ≤ (<code>n</code>) - <strong>y-axis:</strong> CMV-associated TCRŒ≤ (<code>k</code>) - <strong>color:</strong> phenotype group (HCMV‚Å∫ vs HCMV‚Åª)</p>
<p>This visualization helps confirm that both cohorts share similar distributions, while HCMV‚Å∫ individuals tend to carry more phenotype-associated TCRs overall.</p>
<blockquote>
<p>üí° <em>Note:</em><br />
This plot (scatter of <code>k</code> vs <code>n</code>) was not shown in the original Emerson <em>et al.</em> paper, but it provides an intuitive overview of data structure and group separation.</p>
</blockquote>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>Train<span class="op">=</span>pd.read_csv(<span class="st">&#39;HCMV_Train_Matrix_in_paper.tsv&#39;</span>,sep<span class="op">=</span><span class="st">&#39;</span><span class="ch">\t</span><span class="st">&#39;</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>Train_C0<span class="op">=</span>Train[Train[<span class="st">&#39;factor&#39;</span>]<span class="op">==</span><span class="dv">0</span>]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>Train_C1<span class="op">=</span>Train[Train[<span class="st">&#39;factor&#39;</span>]<span class="op">==</span><span class="dv">1</span>]</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>N0,N1<span class="op">=</span>Train_C0.shape[<span class="dv">0</span>],Train_C1.shape[<span class="dv">0</span>]</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>Eval<span class="op">=</span>pd.read_csv(<span class="st">&#39;HCMV_Eval_Matrix_in_paper.tsv&#39;</span>,sep<span class="op">=</span><span class="st">&#39;</span><span class="ch">\t</span><span class="st">&#39;</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>Eval_C0<span class="op">=</span>Eval[Eval[<span class="st">&#39;factor&#39;</span>]<span class="op">==</span><span class="dv">0</span>]</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>Eval_C1<span class="op">=</span>Eval[Eval[<span class="st">&#39;factor&#39;</span>]<span class="op">==</span><span class="dv">1</span>]</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>Train </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib <span class="im">import</span> pyplot <span class="im">as</span> plt</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>fig,ax<span class="op">=</span>plt.subplots(<span class="dv">1</span>,<span class="dv">2</span>,figsize<span class="op">=</span>(<span class="dv">9</span><span class="op">*</span><span class="dv">2</span>,<span class="dv">8</span>))</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_title(<span class="ss">f&#39;Cohort 01:Train dataset</span><span class="ch">\n</span><span class="ss">n=640&#39;</span>,fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>]<span class="op">=</span>sns.scatterplot(x<span class="op">=</span><span class="st">&#39;n&#39;</span>,y<span class="op">=</span><span class="st">&#39;k&#39;</span>,hue<span class="op">=</span><span class="st">&#39;group&#39;</span>,data<span class="op">=</span>Train.sort_values(by<span class="op">=</span><span class="st">&#39;factor&#39;</span>,ascending<span class="op">=</span><span class="va">False</span>),ax<span class="op">=</span>ax[<span class="dv">0</span>],palette<span class="op">=</span>[<span class="st">&#39;tomato&#39;</span>,<span class="st">&#39;skyblue&#39;</span>],alpha<span class="op">=</span><span class="fl">0.75</span>,s<span class="op">=</span><span class="dv">80</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_title(<span class="ss">f&#39;Cohort 02:Evaluate dataset</span><span class="ch">\n</span><span class="ss">n=120&#39;</span>,fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>]<span class="op">=</span>sns.scatterplot(x<span class="op">=</span><span class="st">&#39;n&#39;</span>,y<span class="op">=</span><span class="st">&#39;k&#39;</span>,hue<span class="op">=</span><span class="st">&#39;group&#39;</span>,data<span class="op">=</span>Eval.sort_values(by<span class="op">=</span><span class="st">&#39;factor&#39;</span>,ascending<span class="op">=</span><span class="va">False</span>),ax<span class="op">=</span>ax[<span class="dv">1</span>],palette<span class="op">=</span>[<span class="st">&#39;tomato&#39;</span>,<span class="st">&#39;skyblue&#39;</span>],alpha<span class="op">=</span><span class="fl">0.75</span>,s<span class="op">=</span><span class="dv">80</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> [<span class="dv">0</span>,<span class="dv">1</span>]:</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    ax[i].legend(fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    ax[i].set_ylim(<span class="op">-</span><span class="dv">5</span>,<span class="dv">65</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    ax[i].set_xlim(<span class="op">-</span><span class="dv">50000</span>,<span class="dv">650000</span>)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    ax[i].set_ylabel(<span class="vs">fr&quot;CMV-associated TCR $\beta$&quot;</span>,fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    ax[i].tick_params(rotation<span class="op">=</span><span class="dv">60</span>,labelsize<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    ax[i].set_xlabel(<span class="vs">fr&quot;Unique TCR $\beta$&quot;</span>,fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    ax[i].set_xticklabels([<span class="dv">0</span>]<span class="op">+</span>[<span class="ss">f&#39;</span><span class="sc">{x</span><span class="op">*</span><span class="bu">pow</span>(<span class="dv">10</span>,<span class="dv">5</span>)<span class="sc">:,}</span><span class="ss">&#39;</span> <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">7</span>)])</span></code></pre></div>
<figure>
<img src="BetaBionmial-BayesInfer-TCR-2017-NatGen_files/BetaBionmial-BayesInfer-TCR-2017-NatGen_7_1.png" alt="png" /><figcaption aria-hidden="true">png</figcaption>
</figure>
<hr />
<h4 id="objective">Objective</h4>
<p>In the next sections, we will demonstrate how to implement <strong>Step 2 (Beta‚ÄìBinomial generative modeling)</strong> and <strong>Step 3 (Bayesian MAP classification)</strong> using both <strong>Python</strong> and <strong>R</strong>.</p>
<ul>
<li><p><strong>Step 2:</strong><br />
Fit separate Beta‚ÄìBinomial distributions for the CMV‚Å∫ and CMV‚Åª groups using the observed pairs <span class="math inline">\((k_i, n_i)\)</span> in the training cohort.<br />
Estimate parameters <span class="math inline">\((\alpha_+, \beta_+)\)</span> and <span class="math inline">\((\alpha_-, \beta_-)\)</span> either by maximum likelihood (MLE) or the method of moments.</p></li>
<li><p><strong>Step 3:</strong><br />
For each test sample, compute the likelihood of its <span class="math inline">\((k_i, n_i)\)</span> under both models and estimate posterior probabilities of being CMV‚Å∫ or CMV‚Åª.<br />
The phenotype with the higher posterior probability is assigned by the <strong>Maximum A Posteriori (MAP)</strong> decision rule.</p></li>
</ul>
<p>Both Python and R implementations will be provided in parallel, allowing direct comparison of the parameter estimation and prediction workflow.</p>
<h4 id="r-implementation-1">R Implementation</h4>
<p><strong>Parameter Estimation via Beta‚ÄìBinomial Maximum Likelihood</strong></p>
<p>To estimate the Beta‚ÄìBinomial parameters <span class="math inline">\((\alpha_y, \beta_y)\)</span> for each phenotype group, we adopt a Maximum Likelihood Estimation (MLE) approach implemented in R.</p>
<p>The following functions are based on the <strong>Empirical Bayes estimation framework</strong> described by <em>Supplyframe (2013)</em>, which provides MLE routines for the Beta‚ÄìBinomial model.<br />
Original reference implementation: üîó <a href="https://github.com/Supplyframe/EmpiricalBayesR/blob/master/EmpiricalBayesEstimation.R">Supplyframe/EmpiricalBayesR ‚Äì <code>EmpiricalBayesEstimation.R</code></a></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>BetaBinoMLE <span class="ot">=</span> <span class="cf">function</span> (success, trials, <span class="at">start =</span> <span class="cn">NULL</span>, <span class="at">optim.method =</span> <span class="st">&quot;default&quot;</span>, </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">upper =</span> <span class="cn">Inf</span>) {</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="do">#################################################################################</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MLE estimate of Beta-Binomial parameters</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Args:  </span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#      success: vector of #success; trials:=vector of #trials; </span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#      start: initial parameters (must be a list with name shape1, shape2)</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">#      optim.method: optimization methods in optim(){stats}</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#      lower(upper): lower(upper) bound for parameters</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Returns: </span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         $estimate: MLE estimate for beta parameters   </span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         $convergence: convergence code from optim(). 0 means good.</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         $loglik: Loglikelihood with estimated parameters</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         $starting: initial parameters from the method of moments</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dependent package: VGAM</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note: The structure of the function heavily relies on </span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">#       mledist(){fitdistrplus} by Marie Laure Delignette-Muller.</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Summer2013 @Supplyframe</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="do">#################################################################################</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.element</span>(<span class="st">&quot;VGAM&quot;</span>, <span class="fu">installed.packages</span>()[,<span class="dv">1</span>])){</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;Please install and load package VGAM before using this function.&quot;</span>)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">require</span>(VGAM)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    distname <span class="ot">&lt;-</span> <span class="st">&quot;betabinom.ab&quot;</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    ddistname <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;d&quot;</span>, distname, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(start)) {</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (distname <span class="sc">==</span> <span class="st">&quot;betabinom.ab&quot;</span>) {</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">any</span>(success<span class="sc">/</span>trials <span class="sc">&lt;</span> <span class="dv">0</span>) <span class="sc">|</span> <span class="fu">any</span>(success<span class="sc">/</span>trials <span class="sc">&gt;</span> <span class="dv">1</span>)) {</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;Proportion must be in [0-1] to fit a betabinom distribution&quot;</span>)</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>        } </span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        start.mu <span class="ot">&lt;-</span> <span class="fu">mean</span>(success<span class="sc">/</span>trials)</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>        start.var <span class="ot">&lt;-</span> <span class="fu">var</span>(success<span class="sc">/</span>trials)</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>        start.a <span class="ot">&lt;-</span> ((<span class="dv">1</span> <span class="sc">-</span> start.mu) <span class="sc">/</span> start.var <span class="sc">-</span> <span class="dv">1</span> <span class="sc">/</span> start.mu) <span class="sc">*</span> start.mu <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>        start.b <span class="ot">&lt;-</span> start.a <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">/</span> start.mu <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>        start <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">shape1 =</span> start.a, <span class="at">shape2 =</span> start.b)</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.list</span>(start)) </span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">&quot;&#39;start&#39; must be defined as a named list for this distribution&quot;</span>)</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>    vstart <span class="ot">&lt;-</span> <span class="fu">unlist</span>(start)</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    argddistname <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">formals</span>(ddistname))</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> <span class="fu">match</span>(<span class="fu">names</span>(start), argddistname)</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(<span class="fu">is.na</span>(m)) <span class="sc">||</span> <span class="fu">length</span>(m) <span class="sc">==</span> <span class="dv">0</span>) </span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&quot;&#39;start&#39; must specify names which are arguments to &#39;distr&#39;&quot;</span>)</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>    fnobj <span class="ot">&lt;-</span> <span class="cf">function</span>(par, x, n, ddistnam) {</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">do.call</span>(ddistnam, <span class="fu">c</span>(<span class="fu">list</span>(x), <span class="fu">list</span>(n), par, <span class="at">log =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (optim.method <span class="sc">==</span> <span class="st">&quot;default&quot;</span>) {</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.infinite</span>(lower) <span class="sc">&amp;&amp;</span> <span class="fu">is.infinite</span>(upper)) {</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">length</span>(vstart) <span class="sc">&gt;</span> <span class="dv">1</span>) </span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>        meth <span class="ot">&lt;-</span> <span class="st">&quot;Nelder-Mead&quot;</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> meth <span class="ot">&lt;-</span> <span class="st">&quot;BFGS&quot;</span></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> meth <span class="ot">&lt;-</span> <span class="st">&quot;L-BFGS-B&quot;</span></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> meth <span class="ot">&lt;-</span> optim.method</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>    opttryerror <span class="ot">&lt;-</span> <span class="fu">try</span>(opt <span class="ot">&lt;-</span> <span class="fu">optim</span>(<span class="at">par =</span> start, <span class="at">fn =</span> fnobj, </span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">x =</span> success, <span class="at">n =</span> trials, <span class="at">ddistnam =</span> ddistname, </span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">hessian =</span> <span class="cn">TRUE</span>, <span class="at">method =</span> meth, <span class="at">lower =</span> lower, </span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">upper =</span> upper), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">inherits</span>(opttryerror, <span class="st">&quot;try-error&quot;</span>)) {</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warnings</span>(<span class="st">&quot;The function optim encountered an error and stopped&quot;</span>)</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(opttryerror)</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">estimate =</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">length</span>(vstart)), <span class="at">convergence =</span> <span class="dv">100</span>, </span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>                <span class="at">loglik =</span> <span class="cn">NA</span>, <span class="at">hessian =</span> <span class="cn">NA</span>))</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (opt<span class="sc">$</span>convergence <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warnings</span>(<span class="st">&quot;The function optim failed to converge, with the error code &quot;</span>, </span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>                opt<span class="sc">$</span>convergence)</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">estimate =</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">length</span>(vstart)), <span class="at">convergence =</span> opt<span class="sc">$</span>convergence, </span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>                <span class="at">loglik =</span> <span class="cn">NA</span>, <span class="at">hessian =</span> <span class="cn">NA</span>, <span class="at">message =</span> opt<span class="sc">$</span>message))</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">estimate =</span> opt<span class="sc">$</span>par, <span class="at">convergence =</span> opt<span class="sc">$</span>convergence, </span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>                <span class="at">loglik =</span> <span class="sc">-</span>opt<span class="sc">$</span>value, <span class="at">initial =</span> vstart)</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(res)</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>    EbPropEstor <span class="ot">=</span> <span class="cf">function</span>(success, trials){</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Empirical Bayes estimator for binomial proportion</span></span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span></span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Args: success: a vector of #success</span></span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">#       trials: a vector of #trials</span></span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>    <span class="co">#        </span></span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Returns: a vector of estimated proportion.</span></span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>    <span class="co">#        </span></span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dependent Function: BetaBinoMLE()</span></span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Summer2013 @Supplyframe</span></span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>    est <span class="ot">=</span> <span class="fu">BetaBinoMLE</span>(success, trials)<span class="sc">$</span>estimate</span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">=</span> est[<span class="dv">1</span>]</span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">=</span> est[<span class="dv">2</span>]</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>    proportion <span class="ot">=</span> (a <span class="sc">+</span> success)<span class="sc">/</span>(a <span class="sc">+</span> b <span class="sc">+</span> trials)</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(proportion)  </span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><strong>Parameter Fitting from Training Cohort</strong></p>
<p>In this step, we read the processed training dataset <code>HCMV_Train_Matrix_in_paper.tsv</code> and estimate the group-specific Beta‚ÄìBinomial parameters for <strong>HCMV‚Åª (factor = 0)</strong> and <strong>HCMV‚Å∫ (factor = 1)</strong>.</p>
<p><strong>Command executed:</strong> the following R code uses <code>BetaBinoMLE()</code> to fit each group‚Äôs parameters and outputs four values ‚Äî <code>a0</code>, <code>b0</code>, <code>a1</code>, and <code>b1</code>.</p>
<p><strong>Goal:</strong> model the distribution of phenotype burden (the fraction of phenotype-associated TCRŒ≤ sequences) for each group, which will be used later for likelihood and posterior calculations (Step 3).</p>
<p>The model assumes:</p>
<p><span class="math display">\[
k_i \mid n_i, p_y \sim \mathrm{Binomial}(n_i, p_y), \quad
p_y \sim \mathrm{Beta}(\alpha_y, \beta_y).
\]</span></p>
<p>Here, <span class="math inline">\((\alpha_0, \beta_0)\)</span> correspond to HCMV‚Åª and <span class="math inline">\((\alpha_1, \beta_1)\)</span> to HCMV‚Å∫.</p>
<blockquote>
<p>üí° <strong>Note:</strong><br />
The fitted parameters from our reproduction may slightly differ from those reported in the original paper,<br />
where <span class="math inline">\((\alpha_0, \beta_0) = (26.7, 2{,}814{,}963.8)\)</span> and <span class="math inline">\((\alpha_1, \beta_1) = (4, 51{,}820.1)\)</span>.</p>
</blockquote>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Parameter Fitting from Training Cohort ####</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load processed individual-level data</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>idata <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;HCMV_Train_Matrix_in_paper.tsv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Quick check of the first few records</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(idata, <span class="dv">4</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Split by phenotype group</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>c0 <span class="ot">&lt;-</span> <span class="fu">subset</span>(idata, factor <span class="sc">==</span> <span class="dv">0</span>)   <span class="co"># HCMV‚Äì</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>c1 <span class="ot">&lt;-</span> <span class="fu">subset</span>(idata, factor <span class="sc">==</span> <span class="dv">1</span>)   <span class="co"># HCMV+</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Number of samples:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  HCMV‚Äì group:&quot;</span>, <span class="fu">nrow</span>(c0), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;  HCMV+ group:&quot;</span>, <span class="fu">nrow</span>(c1), <span class="st">&quot;</span><span class="sc">\n\n</span><span class="st">&quot;</span>)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit Beta‚ÄìBinomial parameters for each group</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>fit0 <span class="ot">&lt;-</span> <span class="fu">BetaBinoMLE</span>(c0<span class="sc">$</span>k, c0<span class="sc">$</span>n)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">BetaBinoMLE</span>(c1<span class="sc">$</span>k, c1<span class="sc">$</span>n)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract parameters</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>a0 <span class="ot">&lt;-</span> fit0<span class="sc">$</span>estimate[<span class="dv">1</span>]</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>b0 <span class="ot">&lt;-</span> fit0<span class="sc">$</span>estimate[<span class="dv">2</span>]</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>a1 <span class="ot">&lt;-</span> fit1<span class="sc">$</span>estimate[<span class="dv">1</span>]</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>b1 <span class="ot">&lt;-</span> fit1<span class="sc">$</span>estimate[<span class="dv">2</span>]</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Print results in a tidy format</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Estimated Beta‚ÄìBinomial parameters:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;  HCMV‚Äì group: Œ±0 = %.3f, Œ≤0 = %.3f</span><span class="sc">\n</span><span class="st">&quot;</span>, a0, b0))</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">&quot;  HCMV+ group: Œ±1 = %.3f, Œ≤1 = %.3f</span><span class="sc">\n</span><span class="st">&quot;</span>, a1, b1))</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: save the fitted parameters for later use</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="fu">c</span>(<span class="st">&quot;HCMV-&quot;</span>, <span class="st">&quot;HCMV+&quot;</span>),</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fu">c</span>(a0, a1),</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta  =</span> <span class="fu">c</span>(b0, b1),</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">loglik =</span> <span class="fu">c</span>(fit0<span class="sc">$</span>loglik, fit1<span class="sc">$</span>loglik)</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>params</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(params, <span class="st">&quot;HCMV_BetaBinomial_Params.tsv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>, <span class="at">quote =</span> <span class="cn">FALSE</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>Number of samples:
  HCMV‚Äì group: 351 
  HCMV+ group: 289 

Estimated Beta‚ÄìBinomial parameters:
  HCMV‚Äì group: Œ±0 = 0.769, Œ≤0 = 77361.698
  HCMV+ group: Œ±1 = 1.416, Œ≤1 = 13731.052</code></pre>
<p><strong>Visualizing Fitted Beta‚ÄìBinomial Priors</strong></p>
<p>After estimating the Beta‚ÄìBinomial parameters <span class="math inline">\((\alpha_y, \beta_y)\)</span> for both groups in Step 2, we visualize their corresponding <strong>Beta prior distributions</strong> to verify whether the estimated shapes match the expected phenotype separation.</p>
<p><strong>File used:</strong><br />
<code>HCMV_Train_Matrix_in_paper.tsv</code> (same as in Step 2)</p>
<p><strong>Command executed:</strong><br />
The R code below defines a custom function <code>plot_beta_priors()</code> and uses the fitted parameters <code>a0</code>, <code>b0</code>, <code>a1</code>, and <code>b1</code> to draw Beta probability densityfunctions for the <strong>HCMV‚Åª</strong> and <strong>HCMV‚Å∫</strong> groups.</p>
<p><strong>Goal:</strong><br />
To compare the two fitted Beta distributions and confirm that the CMV‚Å∫ group exhibits a higher mean burden (probability that a TCR is CMV-associated) than the CMV‚Åª group.</p>
<p>The two prior distributions are defined as:</p>
<p><span class="math display">\[
p_y \sim \mathrm{Beta}(\alpha_y, \beta_y),
\quad y \in \{\text{HCMV}^-, \text{HCMV}^+\}.
\]</span></p>
<p>The resulting plot shows their probability density functions over a small range of <span class="math inline">\(p_y\)</span> values, typically <span class="math inline">\([0, 0.0002]\)</span>, highlighting the contrast in prior shapes between groups.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visual check (optional)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare empirical vs fitted Beta‚ÄìBinomial distributions</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>plot_beta_priors <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  a0, b0, a1, b1,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;CMV ‚Äì&quot;</span>, <span class="st">&quot;CMV +&quot;</span>),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">colors =</span> <span class="fu">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;red&quot;</span>),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">&quot;Beta-distributed priors for CMV +and CMV ‚Äìsubjects&quot;</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">x_label =</span> <span class="st">&quot;Probability that a TCR is CMV-associated&quot;</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_label =</span> <span class="cn">NULL</span>,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend_pos =</span> <span class="fu">c</span>(<span class="fl">0.70</span>, <span class="fl">0.85</span>),     <span class="co"># (x,y) relative coords in plot area</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend_bg_alpha =</span> <span class="fl">0.6</span>,          <span class="co"># transparency of legend box</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">x_breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.0002</span>, <span class="at">by =</span> <span class="fl">0.00005</span>),</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">line_width =</span> <span class="fl">1.2</span>,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha=</span><span class="fl">0.6</span>,</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">base_font =</span> <span class="dv">16</span>,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig_width =</span> <span class="dv">6</span>,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig_height =</span> <span class="dv">6</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ------------------------------------------------------------</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Function: plot_beta_priors</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Description:</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   Draws Beta-distributed prior PDFs for two groups (e.g., CMV+ / CMV‚Äì).</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Arguments:</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   a0, b0 : shape parameters of Beta for group 1</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   a1, b1 : shape parameters of Beta for group 2</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   labels : legend labels (default = c(&quot;CMV ‚Äì&quot;, &quot;CMV +&quot;))</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   colors : line colors</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   title, x_label, y_label : text labels for the plot</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   legend_pos : legend position in relative coordinates (0‚Äì1)</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   legend_bg_alpha : transparency of legend box (0=transparent)</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   x_breaks : numeric vector of x-axis tick positions</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   line_width : thickness of curve lines</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   base_font : base font size</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   fig_width, fig_height : size of figure in inches (used for saving)</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Returns:</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   A ggplot object that can be printed or saved</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Example:</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   p &lt;- plot_beta_priors(0.7,77000,1.4,14000,legend_pos=c(0.7,0.8))</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   print(p)</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ------------------------------------------------------------</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate PDF curves</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(x_breaks), <span class="fu">max</span>(x_breaks), <span class="at">length.out =</span> <span class="dv">300</span>)</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>  y0 <span class="ot">&lt;-</span> <span class="fu">dbeta</span>(x, a0, b0)</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> <span class="fu">dbeta</span>(x, a1, b1)</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">rep</span>(x, <span class="dv">2</span>),</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">Density =</span> <span class="fu">c</span>(y0, y1),</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">Group =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(labels, <span class="at">each =</span> <span class="fu">length</span>(x)), <span class="at">levels =</span> labels)</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create formatted group labels (with alpha/beta values)</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>  group_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">&quot;%s (Œ± = %.2f, Œ≤ = %.2f)&quot;</span>, labels[<span class="dv">1</span>], a0, b0),</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">&quot;%s (Œ± = %.2f, Œ≤ = %.2f)&quot;</span>, labels[<span class="dv">2</span>], a1, b1)</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>Group <span class="ot">&lt;-</span> <span class="fu">factor</span>(df<span class="sc">$</span>Group, <span class="at">labels =</span> group_labels)</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot</span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> Density, <span class="at">color =</span> Group)) <span class="sc">+</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">linewidth =</span> line_width, <span class="at">alpha=</span>alpha) <span class="sc">+</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> colors) <span class="sc">+</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>      <span class="at">breaks =</span> x_breaks,</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">sprintf</span>(<span class="st">&quot;%.5f&quot;</span>, x_breaks)</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> title,</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> x_label,</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> y_label</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> base_font) <span class="sc">+</span></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> base_font <span class="sc">+</span> <span class="dv">2</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face =</span> <span class="st">&quot;plain&quot;</span>),</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> base_font, <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">10</span>)),</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> base_font, <span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">r =</span> <span class="dv">10</span>)),</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> base_font <span class="sc">-</span> <span class="dv">2</span>, <span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),<span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>      <span class="co">#panel.grid.minor = element_blank(),</span></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>      <span class="co">#panel.grid.major.y = element_blank(),</span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_blank</span>(), <span class="co">#legend.box.background = element_blank(),</span></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> base_font <span class="sc">-</span> <span class="dv">2</span>),</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>      <span class="co">#legend.background = element_rect(fill = alpha(&quot;white&quot;, legend_bg_alpha), color = &quot;grey70&quot;),</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> legend_pos</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Optionally return dimensions</span></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attr</span>(p, <span class="st">&quot;fig_width&quot;</span>) <span class="ot">&lt;-</span> fig_width</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attr</span>(p, <span class="st">&quot;fig_height&quot;</span>) <span class="ot">&lt;-</span> fig_height</span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(p)</span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width =</span> <span class="dv">5</span>, <span class="at">repr.plot.height =</span> <span class="dv">5</span>, <span class="at">repr.plot.res=</span><span class="dv">300</span>)</span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>p_beta <span class="ot">&lt;-</span> <span class="fu">plot_beta_priors</span>(a0, b0, a1, b1,<span class="at">legend_pos=</span><span class="fu">c</span>(<span class="fl">0.7</span>,<span class="fl">0.8</span>),<span class="at">colors =</span> <span class="fu">c</span>(<span class="st">&#39;#00BFC4&#39;</span>,<span class="st">&#39;#F8766D&#39;</span>),<span class="at">base_font =</span> <span class="dv">18</span>)</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>p_beta</span></code></pre></div>
<figure>
<img src="BetaBionmial-BayesInfer-TCR-2017-NatGen_files/BetaBionmial-BayesInfer-TCR-2017-NatGen_16_0.png" alt="png" /><figcaption aria-hidden="true">png</figcaption>
</figure>
<p><strong>Bayesian Classification and Model Evaluation</strong></p>
<p>In this step, I use the fitted Beta‚ÄìBinomial parameters from <strong>Step 2</strong> to perform phenotype prediction for each sample and evaluate the model performance.</p>
<p><strong>File used:</strong><br />
- <code>HCMV_Train_Matrix_in_paper.tsv</code> ‚Äî for training parameters<br />
- <code>HCMV_Eval_Matrix_in_paper.tsv</code> ‚Äî for testing / evaluation</p>
<p><strong>Commands executed:</strong><br />
The following R code defines utility functions for three purposes:</p>
<ol type="1">
<li><p><strong><code>calc_BF()</code> ‚Äî Compute the Bayes Factor (BF)</strong><br />
For each sample with counts <span class="math inline">\((k_i, n_i)\)</span>, the log-Bayes Factor compares the likelihood under the two Beta‚ÄìBinomial models (HCMV‚Å∫ vs HCMV‚Åª):</p>
<p><span class="math display">\[
\mathrm{BF}_i = 
\log\!\frac{P(k_i \mid n_i,\alpha_1,\beta_1)}{P(k_i \mid n_i,\alpha_0,\beta_0)}
+ \log\!\frac{N_1+1}{N_0+1},
\]</span> where <span class="math inline">\((\alpha_1,\beta_1)\)</span> and <span class="math inline">\((\alpha_0,\beta_0)\)</span> are the fitted parameters for CMV‚Å∫ and CMV‚Åª groups, respectively, and <span class="math inline">\(N_1,N_0\)</span> are the numbers of subjects in each group (used for prior weighting). A higher BF indicates stronger evidence that the sample belongs to CMV‚Å∫.</p></li>
<li><p><strong><code>roc_auc_ci()</code> ‚Äî Compute AUC and 95% confidence interval</strong><br />
Uses the <code>pROC</code> package to evaluate model discrimination ability based on true labels (<code>y_true</code>) and predicted scores (<code>y_score = log BF</code>).</p></li>
<li><p><strong>ROC curve visualization</strong><br />
The final part calls a helper script <code>roc_utils.R</code> to plot ROC curves and visualize model performance.</p></li>
</ol>
<p><strong>Goal:</strong><br />
Quantify how well the Beta‚ÄìBinomial Bayesian classifier distinguishes CMV‚Å∫ from CMV‚Åª subjects and compare the performance against the results reported in the original Emerson <em>et al.</em> study.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================================================</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">#      Compute Beta-Binomial Bayes Factor (BF)</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================================================</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Args:</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   k, n : counts of CMV-associated TCRs (k) and total unique TCRs (n)</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   a0, b0, a1, b1 : Beta prior parameters for CMV- and CMV+ groups</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   N0, N1 : Number of subjects in each group (used for prior weighting)</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Returns:</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   A single numeric Bayes Factor value</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>calc_BF <span class="ot">&lt;-</span> <span class="cf">function</span>(k, n, a0, b0, a1, b1, N0, N1) {</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    BF <span class="ot">&lt;-</span> <span class="fu">log</span>(N1 <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">-</span> <span class="fu">log</span>(N0 <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">lbeta</span>(a0, b0) <span class="sc">-</span> <span class="fu">lbeta</span>(a1, b1) <span class="sc">+</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lbeta</span>(k <span class="sc">+</span> a1, n <span class="sc">-</span> k <span class="sc">+</span> b1) <span class="sc">-</span> <span class="fu">lbeta</span>(k <span class="sc">+</span> a0, n <span class="sc">-</span> k <span class="sc">+</span> b0)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(BF)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================================================</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="co">#      Compute ROC AUC and its 95% Confidence Interval</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================================================</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Args:</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co">#   y_true  : Numeric vector (true labels, 0/1)</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="co">#   y_score : Numeric vector (predicted scores, e.g., log(BF))</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Returns:</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="co">#   A list containing AUC value and CI (lower, mean, upper)</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Example:</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="co">#   result &lt;- roc_auc_ci(c(0,1,1,0), c(0.1,0.8,0.7,0.3))</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="co">#   result$AUC; result$CI</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pROC)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>roc_auc_ci <span class="ot">&lt;-</span> <span class="cf">function</span>(y_true, y_score) {</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(y_true, y_score, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    auc_val <span class="ot">&lt;-</span> <span class="fu">auc</span>(roc_obj)</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    ci_val <span class="ot">&lt;-</span> <span class="fu">ci.auc</span>(roc_obj)</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">AUC =</span> auc_val, <span class="at">CI =</span> ci_val))</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================================================</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a><span class="co">#                   Plot ROC curves</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================================================</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&#39;../../scripts/R/roc_utils.R&#39;</span>)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a><span class="fu">lsf.str</span>()</span></code></pre></div>
<pre><code>BetaBinoMLE : function (success, trials, start = NULL, optim.method = &quot;default&quot;, lower = 0, 
    upper = Inf)  
calc_BF : function (k, n, a0, b0, a1, b1, N0, N1)  
EbPropEstor : function (success, trials)  
plot_beta_priors : function (a0, b0, a1, b1, labels = c(&quot;CMV ‚Äì&quot;, &quot;CMV +&quot;), colors = c(&quot;blue&quot;, 
    &quot;red&quot;), title = &quot;Beta-distributed priors for CMV +and CMV ‚Äìsubjects&quot;, 
    x_label = &quot;Probability that a TCR is CMV-associated&quot;, y_label = NULL, 
    legend_pos = c(0.7, 0.85), legend_bg_alpha = 0.6, x_breaks = seq(0, 
        2e-04, by = 5e-05), line_width = 1.2, alpha = 0.6, base_font = 16, 
    fig_width = 6, fig_height = 6)  
plot_roc_overlay : function (infer_df = NULL, datasets = NULL, truth_col = &quot;true&quot;, score_col = &quot;score&quot;, 
    colors = NULL, line_width = 1.2, line_alpha = 0.9, title_main = &quot;ROC Curve Comparison&quot;, 
    x_label = &quot;Specificity&quot;, y_label = &quot;Sensitivity&quot;, base_font = 16, legend_position = &quot;right&quot;, 
    help = FALSE)  
plot_roc_panels : function (infer_df, datasets = c(&quot;Cohort 01&quot;, &quot;Cohort 02&quot;), truth_col = &quot;true&quot;, 
    score_col = &quot;score&quot;, colors = c(&quot;#F8766D&quot;), line_width = 1.2, line_alpha = 0.9, 
    title_main = &quot;ROC Curve Analysis&quot;, x_label = &quot;Specificity&quot;, y_label = &quot;Sensitivity&quot;, 
    show_auc_label = TRUE, auc_pos = c(0.35, 0.18), auc_digits = 3, ncol = 2, 
    base_font = 16, help = FALSE)  
roc_auc_ci : function (y_true = NULL, y_score = NULL, help = FALSE)  
run_BF_inference : function (datasets, a0, b0, a1, b1, N0, N1)  </code></pre>
<blockquote>
<p>üí° See details about ROC plotting in Data Visualization Section,<a href="../../viz/roc_plot/roc_plot_combined.html">ROC Curve Visualization ‚Äî Comparing Model Separability</a>.</p>
</blockquote>
<p><strong>Inference and Evaluation</strong></p>
<p>Using the fitted Beta‚ÄìBinomial parameters, we computed Bayes factors for all individuals and plotted ROC curves for both cohorts.<br />
The resulting AUROC values ‚Äî <strong>0.98</strong> for Cohort 01 and <strong>0.94</strong> for Cohort 02 ‚Äî are <strong>highly comparable</strong> to those reported in the original study.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>Train <span class="ot">&lt;-</span> <span class="fu">read.delim</span>(<span class="st">&quot;HCMV_Train_Matrix_in_paper.tsv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>Eval  <span class="ot">&lt;-</span> <span class="fu">read.delim</span>(<span class="st">&quot;HCMV_Eval_Matrix_in_paper.tsv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>Train_C0 <span class="ot">&lt;-</span> <span class="fu">filter</span>(Train, factor <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>Train_C1 <span class="ot">&lt;-</span> <span class="fu">filter</span>(Train, factor <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>Eval_C0  <span class="ot">&lt;-</span> <span class="fu">filter</span>(Eval,  factor <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>Eval_C1  <span class="ot">&lt;-</span> <span class="fu">filter</span>(Eval,  factor <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>N0 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(Train_C0)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>N1 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(Train_C1)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>datasets <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">name =</span> <span class="st">&quot;Cohort 01&quot;</span>, <span class="at">label =</span> <span class="dv">0</span>, <span class="at">df =</span> Train_C0),</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">name =</span> <span class="st">&quot;Cohort 01&quot;</span>, <span class="at">label =</span> <span class="dv">1</span>, <span class="at">df =</span> Train_C1),</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">name =</span> <span class="st">&quot;Cohort 02&quot;</span>, <span class="at">label =</span> <span class="dv">0</span>, <span class="at">df =</span> Eval_C0),</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">name =</span> <span class="st">&quot;Cohort 02&quot;</span>, <span class="at">label =</span> <span class="dv">1</span>, <span class="at">df =</span> Eval_C1)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>datasets</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>Infer <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Dataset=</span><span class="fu">character</span>(), <span class="at">true=</span><span class="fu">integer</span>(), <span class="at">inference=</span><span class="fu">integer</span>(), <span class="at">BF=</span><span class="fu">numeric</span>())</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (d <span class="cf">in</span> datasets) {</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> d<span class="sc">$</span>df</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(df))) {</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        k <span class="ot">&lt;-</span> df<span class="sc">$</span>k[i]; n <span class="ot">&lt;-</span> df<span class="sc">$</span>n[i]</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        BF <span class="ot">&lt;-</span> <span class="fu">calc_BF</span>(k, n, a0, b0, a1, b1, N0, N1)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        pred_y <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(BF <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        Infer <span class="ot">&lt;-</span> <span class="fu">rbind</span>(Infer, <span class="fu">data.frame</span>(<span class="at">Dataset=</span>d<span class="sc">$</span>name, <span class="at">true=</span>d<span class="sc">$</span>label, <span class="at">inference=</span>pred_y, <span class="at">BF=</span>BF))</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Infer)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">repr.plot.width =</span> <span class="dv">5</span>, <span class="at">repr.plot.height =</span> <span class="dv">5</span>, <span class="at">repr.plot.res=</span><span class="dv">300</span>)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_roc_panels</span>(Infer, <span class="at">datasets =</span> <span class="fu">c</span>(<span class="st">&quot;Cohort 01&quot;</span>, <span class="st">&quot;Cohort 02&quot;</span>), <span class="at">truth_col =</span> <span class="st">&quot;true&quot;</span>, </span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">score_col =</span> <span class="st">&quot;BF&quot;</span>)</span></code></pre></div>
<figure>
<img src="BetaBionmial-BayesInfer-TCR-2017-NatGen_files/BetaBionmial-BayesInfer-TCR-2017-NatGen_21_0.png" alt="png" /><figcaption aria-hidden="true">png</figcaption>
</figure>
<hr />
<h4 id="python-implementation-1">Python Implementation</h4>
<p><strong>BetaBinoMLE in Python</strong></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.special <span class="im">import</span> betaln</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> minimize</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================================================</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   Beta‚ÄìBinomial MLE estimation (Python version)</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================================================</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> beta_binom_loglik(params, k, n):</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Negative log-likelihood for Beta‚ÄìBinomial.&quot;&quot;&quot;</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    a, b <span class="op">=</span> params</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> a <span class="op">&lt;=</span> <span class="dv">0</span> <span class="kw">or</span> b <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.inf</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    ll <span class="op">=</span> np.<span class="bu">sum</span>(</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        np.log(np.exp(betaln(k <span class="op">+</span> a, n <span class="op">-</span> k <span class="op">+</span> b) <span class="op">-</span> betaln(a, b)))</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> np.log(np.math.comb(n[<span class="dv">0</span>], k[<span class="dv">0</span>]))  <span class="co"># for consistent shape</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>ll</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> BetaBinoMLE(success, trials, start<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="co">    MLE estimate of Beta‚ÄìBinomial parameters (Œ±, Œ≤)</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="co">        success : array-like, number of successes (k)</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="co">        trials  : array-like, number of trials (n)</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="co">        start   : initial values for (Œ±, Œ≤), optional</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="co">        dict with keys [&#39;estimate&#39;, &#39;loglik&#39;, &#39;convergence&#39;]</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    success <span class="op">=</span> np.asarray(success)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    trials <span class="op">=</span> np.asarray(trials)</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> start <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>        p <span class="op">=</span> np.mean(success <span class="op">/</span> trials)</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>        v <span class="op">=</span> np.var(success <span class="op">/</span> trials)</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>        a <span class="op">=</span> ((<span class="dv">1</span> <span class="op">-</span> p) <span class="op">/</span> v <span class="op">-</span> <span class="dv">1</span> <span class="op">/</span> p) <span class="op">*</span> p<span class="op">**</span><span class="dv">2</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>        b <span class="op">=</span> a <span class="op">*</span> (<span class="dv">1</span> <span class="op">/</span> p <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>        start <span class="op">=</span> [<span class="bu">max</span>(a, <span class="fl">1e-3</span>), <span class="bu">max</span>(b, <span class="fl">1e-3</span>)]</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> nll(params):</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>        a, b <span class="op">=</span> params</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> a <span class="op">&lt;=</span> <span class="dv">0</span> <span class="kw">or</span> b <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.inf</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>        log_prob <span class="op">=</span> betaln(success <span class="op">+</span> a, trials <span class="op">-</span> success <span class="op">+</span> b) <span class="op">-</span> betaln(a, b)</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>np.<span class="bu">sum</span>(log_prob)</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> minimize(nll, start, method<span class="op">=</span><span class="st">&quot;L-BFGS-B&quot;</span>, bounds<span class="op">=</span>[(<span class="fl">1e-6</span>, <span class="va">None</span>), (<span class="fl">1e-6</span>, <span class="va">None</span>)])</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;estimate&quot;</span>: res.x,</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;loglik&quot;</span>: <span class="op">-</span>res.fun,</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;convergence&quot;</span>: res.success</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================================================</span></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a><span class="co">#   Empirical Bayes estimator for binomial proportion</span></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================================================</span></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> EbPropEstor(success, trials):</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a><span class="co">    Empirical Bayes estimator for binomial proportions.</span></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a><span class="co">        success : array-like (#success)</span></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a><span class="co">        trials  : array-like (#trials)</span></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a><span class="co">        vector of posterior mean estimates (Œ± + k)/(Œ± + Œ≤ + n)</span></span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>    est <span class="op">=</span> BetaBinoMLE(success, trials)[<span class="st">&quot;estimate&quot;</span>]</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>    a, b <span class="op">=</span> est</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (a <span class="op">+</span> success) <span class="op">/</span> (a <span class="op">+</span> b <span class="op">+</span> trials)</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">### Parameter Fitting from Training Cohort (Python version) </span><span class="al">###</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load processed data</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>idata <span class="op">=</span> pd.read_csv(<span class="st">&quot;HCMV_Train_Matrix_in_paper.tsv&quot;</span>, sep<span class="op">=</span><span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>idata.head(<span class="dv">4</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Split by phenotype</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>c0 <span class="op">=</span> idata[idata[<span class="st">&quot;factor&quot;</span>] <span class="op">==</span> <span class="dv">0</span>]   <span class="co"># HCMV‚Äì</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>c1 <span class="op">=</span> idata[idata[<span class="st">&quot;factor&quot;</span>] <span class="op">==</span> <span class="dv">1</span>]   <span class="co"># HCMV+</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Number of samples:&quot;</span>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;  HCMV‚Äì group: </span><span class="sc">{</span><span class="bu">len</span>(c0)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;  HCMV+ group: </span><span class="sc">{</span><span class="bu">len</span>(c1)<span class="sc">}</span><span class="ch">\n</span><span class="ss">&quot;</span>)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit Beta‚ÄìBinomial parameters for each group</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>fit0 <span class="op">=</span> BetaBinoMLE(c0[<span class="st">&quot;k&quot;</span>], c0[<span class="st">&quot;n&quot;</span>])</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>fit1 <span class="op">=</span> BetaBinoMLE(c1[<span class="st">&quot;k&quot;</span>], c1[<span class="st">&quot;n&quot;</span>])</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>a0, b0 <span class="op">=</span> fit0[<span class="st">&quot;estimate&quot;</span>]</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>a1, b1 <span class="op">=</span> fit1[<span class="st">&quot;estimate&quot;</span>]</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Print results</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Estimated Beta‚ÄìBinomial parameters:&quot;</span>)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;  HCMV‚Äì group: Œ±0 = </span><span class="sc">{a0:.3f}</span><span class="ss">, Œ≤0 = </span><span class="sc">{b0:.3f}</span><span class="ss">&quot;</span>)</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;  HCMV+ group: Œ±1 = </span><span class="sc">{a1:.3f}</span><span class="ss">, Œ≤1 = </span><span class="sc">{b1:.3f}</span><span class="ss">&quot;</span>)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Save results</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> pd.DataFrame({</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;group&quot;</span>: [<span class="st">&quot;HCMV-&quot;</span>, <span class="st">&quot;HCMV+&quot;</span>],</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;alpha&quot;</span>: [a0, a1],</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;beta&quot;</span>:  [b0, b1],</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;loglik&quot;</span>: [fit0[<span class="st">&quot;loglik&quot;</span>], fit1[<span class="st">&quot;loglik&quot;</span>]]</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>params.to_csv(<span class="st">&quot;HCMV_BetaBinomial_Params.tsv&quot;</span>, sep<span class="op">=</span><span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>params</span></code></pre></div>
<pre><code>Number of samples:
  HCMV‚Äì group: 351
  HCMV+ group: 289

Estimated Beta‚ÄìBinomial parameters:
  HCMV‚Äì group: Œ±0 = 0.770, Œ≤0 = 77582.734
  HCMV+ group: Œ±1 = 1.430, Œ≤1 = 13778.735</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
group
</th>
<th>
alpha
</th>
<th>
beta
</th>
<th>
loglik
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
HCMV-
</td>
<td>
0.770166
</td>
<td>
77582.733529
</td>
<td>
-6656.666364
</td>
</tr>
<tr>
<th>
1
</th>
<td>
HCMV+
</td>
<td>
1.429792
</td>
<td>
13778.735072
</td>
<td>
-45305.400421
</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p><strong>Result note (R vs Python):</strong><br />
Using the training dataset, the fitted Beta‚ÄìBinomial parameters are:</p>
<p><strong>R version</strong></p>
<pre><code>      HCMV‚Äì group: Œ±‚ÇÄ = 0.769, Œ≤‚ÇÄ = 77,361.698  
      HCMV+ group: Œ±‚ÇÅ = 1.416, Œ≤‚ÇÅ = 13,731.052  </code></pre>
<p><strong>Python version</strong></p>
<pre><code>      HCMV‚Äì group: Œ±‚ÇÄ = 0.770, Œ≤‚ÇÄ = 77,582.734  
      HCMV+ group: Œ±‚ÇÅ = 1.430, Œ≤‚ÇÅ = 13,778.735  </code></pre>
<p>The numerical values differ slightly due to optimization implementation, but the relative relationship (Œ±‚ÇÅ &gt; Œ±‚ÇÄ and Œ≤‚ÇÅ &lt; Œ≤‚ÇÄ) is consistent, indicating that the CMV‚Å∫ group exhibits a higher mean burden of CMV-associated TCRŒ≤ sequences.</p>
</blockquote>
<p><strong>Visualizing Fitted Beta‚ÄìBinomial Priors</strong></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> beta</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================================================</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Function: plot_beta_priors (Python version)</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================================================</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_beta_priors(</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    a0, b0, a1, b1,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>(<span class="st">&quot;CMV ‚Äì&quot;</span>, <span class="st">&quot;CMV +&quot;</span>),</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>(<span class="st">&quot;#00BFC4&quot;</span>, <span class="st">&quot;#F8766D&quot;</span>),</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">&quot;Beta-distributed priors for CMV‚Å∫ and CMV‚Åª subjects&quot;</span>,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    x_label<span class="op">=</span><span class="st">&quot;Probability that a TCR is CMV-associated&quot;</span>,</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    y_label<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    legend_loc<span class="op">=</span><span class="st">&quot;upper right&quot;</span>,</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    x_breaks<span class="op">=</span>np.linspace(<span class="dv">0</span>, <span class="fl">0.0002</span>, <span class="dv">5</span>),</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    linewidth<span class="op">=</span><span class="fl">2.0</span>,</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    base_font<span class="op">=</span><span class="dv">16</span>,</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">6</span>)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="co">    Draw Beta-distributed prior PDFs for two groups (e.g., CMV+ / CMV‚Äì).</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="co">    Equivalent to the R version using ggplot.</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.linspace(x_breaks.<span class="bu">min</span>(), x_breaks.<span class="bu">max</span>(), <span class="dv">400</span>)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    y0 <span class="op">=</span> beta.pdf(x, a0, b0)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    y1 <span class="op">=</span> beta.pdf(x, a1, b1)</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>figsize)</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    plt.plot(x, y0, color<span class="op">=</span>colors[<span class="dv">0</span>], lw<span class="op">=</span>linewidth, alpha<span class="op">=</span>alpha,</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{</span>labels[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> (Œ±=</span><span class="sc">{a0:.3f}</span><span class="ss">, Œ≤=</span><span class="sc">{b0:.3f}</span><span class="ss">)&quot;</span>)</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    plt.plot(x, y1, color<span class="op">=</span>colors[<span class="dv">1</span>], lw<span class="op">=</span>linewidth, alpha<span class="op">=</span>alpha,</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{</span>labels[<span class="dv">1</span>]<span class="sc">}</span><span class="ss"> (Œ±=</span><span class="sc">{a1:.3f}</span><span class="ss">, Œ≤=</span><span class="sc">{b1:.3f}</span><span class="ss">)&quot;</span>)</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    plt.title(title, fontsize<span class="op">=</span>base_font <span class="op">+</span> <span class="dv">2</span>)</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(x_label, fontsize<span class="op">=</span>base_font)</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(y_label <span class="cf">if</span> y_label <span class="cf">else</span> <span class="st">&quot;Density&quot;</span>, fontsize<span class="op">=</span>base_font)</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    plt.xticks(x_breaks, [<span class="ss">f&quot;</span><span class="sc">{v:.5f}</span><span class="ss">&quot;</span> <span class="cf">for</span> v <span class="kw">in</span> x_breaks], rotation<span class="op">=</span><span class="dv">90</span>, fontsize<span class="op">=</span>base_font <span class="op">-</span> <span class="dv">2</span>)</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    plt.yticks([])</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    plt.grid(<span class="va">False</span>)</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    plt.legend(fontsize<span class="op">=</span>base_font <span class="op">-</span> <span class="dv">2</span>, loc<span class="op">=</span>legend_loc)</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================================================</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: visualize fitted priors</span></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================================================</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>plot_beta_priors(</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>    a0, b0, a1, b1,</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>(<span class="st">&quot;CMV ‚Äì&quot;</span>, <span class="st">&quot;CMV +&quot;</span>),</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>(<span class="st">&quot;#00BFC4&quot;</span>, <span class="st">&quot;#F8766D&quot;</span>),</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>    base_font<span class="op">=</span><span class="dv">15</span>,</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>    figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">6</span>)</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<figure>
<img src="BetaBionmial-BayesInfer-TCR-2017-NatGen_files/BetaBionmial-BayesInfer-TCR-2017-NatGen_28_0.png" alt="png" /><figcaption aria-hidden="true">png</figcaption>
</figure>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.special <span class="im">import</span> betaln</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> importlib</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================================================</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Compute Beta‚ÄìBinomial Bayes Factor (BF)</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================================================</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calc_BF(k, n, a0, b0, a1, b1, N0, N1):</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute log Bayes Factor comparing Beta‚ÄìBinomial likelihoods</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co">    under CMV+ vs CMV‚Äì priors.</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="co">        k, n : observed counts</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co">        a0, b0 : Beta parameters for CMV‚Äì</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="co">        a1, b1 : Beta parameters for CMV+</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="co">        N0, N1 : number of subjects in each group</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co">        log Bayes Factor (float)</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    BF <span class="op">=</span> np.log(N1 <span class="op">+</span> <span class="dv">1</span>) <span class="op">-</span> np.log(N0 <span class="op">+</span> <span class="dv">1</span>) <span class="op">+</span> betaln(a0, b0) <span class="op">-</span> betaln(a1, b1) <span class="op">\</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">+</span> betaln(k <span class="op">+</span> a1, n <span class="op">-</span> k <span class="op">+</span> b1) <span class="op">-</span> betaln(k <span class="op">+</span> a0, n <span class="op">-</span> k <span class="op">+</span> b0)</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> BF</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================================================</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Model inference and ROC plotting</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================================================</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>Train <span class="op">=</span> pd.read_csv(<span class="st">&quot;HCMV_Train_Matrix_in_paper.tsv&quot;</span>, sep<span class="op">=</span><span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>)</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>Eval <span class="op">=</span> pd.read_csv(<span class="st">&quot;HCMV_Eval_Matrix_in_paper.tsv&quot;</span>, sep<span class="op">=</span><span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>)</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>Train_C0, Train_C1 <span class="op">=</span> Train[Train[<span class="st">&quot;factor&quot;</span>] <span class="op">==</span> <span class="dv">0</span>], Train[Train[<span class="st">&quot;factor&quot;</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>Eval_C0, Eval_C1 <span class="op">=</span> Eval[Eval[<span class="st">&quot;factor&quot;</span>] <span class="op">==</span> <span class="dv">0</span>], Eval[Eval[<span class="st">&quot;factor&quot;</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>N0, N1 <span class="op">=</span> <span class="bu">len</span>(Train_C0), <span class="bu">len</span>(Train_C1)</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>datasets <span class="op">=</span> [</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    {<span class="st">&quot;name&quot;</span>: <span class="st">&quot;Cohort 01&quot;</span>, <span class="st">&quot;label&quot;</span>: <span class="dv">0</span>, <span class="st">&quot;df&quot;</span>: Train_C0},</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    {<span class="st">&quot;name&quot;</span>: <span class="st">&quot;Cohort 01&quot;</span>, <span class="st">&quot;label&quot;</span>: <span class="dv">1</span>, <span class="st">&quot;df&quot;</span>: Train_C1},</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    {<span class="st">&quot;name&quot;</span>: <span class="st">&quot;Cohort 02&quot;</span>, <span class="st">&quot;label&quot;</span>: <span class="dv">0</span>, <span class="st">&quot;df&quot;</span>: Eval_C0},</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>    {<span class="st">&quot;name&quot;</span>: <span class="st">&quot;Cohort 02&quot;</span>, <span class="st">&quot;label&quot;</span>: <span class="dv">1</span>, <span class="st">&quot;df&quot;</span>: Eval_C1},</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>Infer <span class="op">=</span> []</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> d <span class="kw">in</span> datasets:</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> d[<span class="st">&quot;df&quot;</span>]</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>        BF <span class="op">=</span> calc_BF(row.k, row.n, a0, b0, a1, b1, N0, N1)</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>        pred <span class="op">=</span> <span class="dv">1</span> <span class="cf">if</span> BF <span class="op">&gt;=</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>        Infer.append([d[<span class="st">&quot;name&quot;</span>], d[<span class="st">&quot;label&quot;</span>], pred, BF])</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>Infer <span class="op">=</span> pd.DataFrame(Infer, columns<span class="op">=</span>[<span class="st">&quot;Dataset&quot;</span>, <span class="st">&quot;true&quot;</span>, <span class="st">&quot;inference&quot;</span>, <span class="st">&quot;BF&quot;</span>])</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>Infer.head()</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
Dataset
</th>
<th>
true
</th>
<th>
inference
</th>
<th>
BF
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
Cohort 01
</td>
<td>
0
</td>
<td>
0
</td>
<td>
-1.564305
</td>
</tr>
<tr>
<th>
1
</th>
<td>
Cohort 01
</td>
<td>
0
</td>
<td>
0
</td>
<td>
-1.474262
</td>
</tr>
<tr>
<th>
2
</th>
<td>
Cohort 01
</td>
<td>
0
</td>
<td>
0
</td>
<td>
-2.241543
</td>
</tr>
<tr>
<th>
3
</th>
<td>
Cohort 01
</td>
<td>
0
</td>
<td>
0
</td>
<td>
-1.572324
</td>
</tr>
<tr>
<th>
4
</th>
<td>
Cohort 01
</td>
<td>
0
</td>
<td>
0
</td>
<td>
-3.153280
</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================================================</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. ROC visualization</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ================================================================</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>sys.path.append(<span class="st">&quot;../../scripts/Python&quot;</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> roc_utils</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>importlib.<span class="bu">reload</span>(roc_utils)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> roc_utils <span class="im">import</span> plot_roc_panels_pub,roc_auc_ci</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot ROC for both cohorts</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>fig,ax<span class="op">=</span>plot_roc_panels_pub(Infer, datasets<span class="op">=</span>[<span class="st">&quot;Cohort 01&quot;</span>, <span class="st">&quot;Cohort 02&quot;</span>],</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>                    truth_col<span class="op">=</span><span class="st">&quot;true&quot;</span>, score_col<span class="op">=</span><span class="st">&quot;BF&quot;</span>,colors<span class="op">=</span>{<span class="st">&quot;Cohort 01&quot;</span>:<span class="st">&#39;red&#39;</span>, <span class="st">&quot;Cohort 02&quot;</span>:<span class="st">&#39;red&#39;</span>})</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">&quot;ROC Curve Panels&quot;</span>, fontsize<span class="op">=</span><span class="dv">24</span>, fontweight<span class="op">=</span><span class="st">&#39;bold&#39;</span>, x<span class="op">=</span><span class="fl">0.39</span>, y<span class="op">=</span><span class="fl">1.01</span>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Example result:</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Cohort 01 AUC ‚âà 0.98</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Cohort 02 AUC ‚âà 0.94</span></span></code></pre></div>
<pre><code>Text(0.39, 1.01, &#39;ROC Curve Panels&#39;)</code></pre>
<figure>
<img src="BetaBionmial-BayesInfer-TCR-2017-NatGen_files/BetaBionmial-BayesInfer-TCR-2017-NatGen_30_1.png" alt="png" /><figcaption aria-hidden="true">png</figcaption>
</figure>
<h2 id="summary">Summary</h2>
<p>Both the <strong>Python</strong> and <strong>R</strong> implementations achieved highly consistent performance, closely matching the results reported in the original <em>Emerson et al.</em> paper (AUROC ‚âà 0.98 in training and 0.94 in evaluation).</p>
<p>The two matrices used in this practice, <code>HCMV_Train_Matrix_in_paper.tsv</code> and <code>HCMV_Eval_Matrix_in_paper.tsv</code>, were generated from the <strong>immuneACCESS‚Ñ¢</strong> raw data provided by Adaptive Biotechnologies. I independently processed the repertoires to construct these individual-level summary matrices.</p>
<p>Since the preprocessing steps may not be identical to those described in the paper, the resulting counts and fitted parameters differ slightly from the published values. There may also be other subtle, unobserved differences introduced during data handling. Fortunately, the model performance remains highly comparable, demonstrating the robustness of this statistical learning framework. If any errors or inconsistencies are found, I sincerely welcome feedback and corrections.</p>
<p>In this practice, I showed how to reproduce the complete <strong>‚Äúphenotype-associated TCR identification ‚Üí Beta‚ÄìBinomial generative Bayesian classification‚Äù</strong> pipeline in both <strong>R</strong> and <strong>Python</strong>.</p>
<p>This framework can be extended beyond TCR repertoire analysis to other binary classification problems involving count-based proportions and variable sampling depth, including: - immune receptor or antibody repertoire studies,<br />
- microbiome or cfDNA burden modeling, and<br />
- single-cell feature aggregation for phenotype prediction.</p>
<blockquote>
<p>üí° In essence, the Beta‚ÄìBinomial generative model elegantly captures both <strong>sampling variability</strong> and <strong>biological heterogeneity</strong>, making it a powerful and interpretable statistical foundation for biological classification tasks.</p>
</blockquote>
<script type="text/javascript">
// @ts-nocheck

document.addEventListener("DOMContentLoaded", () => {
document.querySelectorAll("div.sourceCode").forEach(block => {
    // Create "Copy" button
    const button = document.createElement("button");
    button.className = "copy-btn";
    button.innerText = "Copy";
    block.prepend(button);

    // Get language name from <pre class="sourceCode bash">...
    const pre = block.querySelector("pre");
    const lang = (pre.className.match(/sourceCode\s+(\w+)/) || [])[1];
    if (lang) block.setAttribute("data-lang", lang);

    // Copy functionality
    button.addEventListener("click", async () => {
        const code = block.querySelector("code").innerText;
        try {
        await navigator.clipboard.writeText(code);
        button.innerText = "Copied!";
        button.style.background = "#d1f7c4";
        setTimeout(() => {
            button.innerText = "Copy";
            button.style.background = "#f6f8fa";
        }, 1800);
        } catch (err) {
        button.innerText = "Error";
        console.error("Copy failed:", err);
        }
    });
    });
});

/* ===== Responsive Image Auto Sizing ===== */
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll("img").forEach(img => {
    img.onload = () => {
        const ratio = img.naturalWidth / img.naturalHeight;

        // Ê†áÂáÜÂàÜÁ±ªÈÄªËæëÔºöÁ´ñÂõæÂ∞è„ÄÅÊ®™ÂõæÂ§ß
        if (ratio < 0.9) {
        img.classList.add("portrait");  // Á´ñÂõæ
        } else if (ratio > 1.5) {
        img.classList.add("landscape"); // ÂÆΩÂõæ
        } else {
        img.classList.add("square");    // ÊñπÂõæ
        }
    };
    });
});

/* ===== TOC style determination ===== */
document.addEventListener("DOMContentLoaded", function() {
    // ÊâæÂà∞ÂÜÖÂÆπ‰∏ª‰Ωì
    const content = document.querySelector("main.content");
    if (!content) return;

    // ÂàõÂª∫ TOC ÂÆπÂô®
    const toc = document.createElement("nav");
    toc.id = "auto-toc";
    toc.innerHTML = "<h3>üìë Contents</h3><ul></ul>";

    // Êää TOC ÊèíÂà∞ content ‰πãÂâç
    const container = document.createElement("div");
    container.className = "toc-container";
    content.parentNode.insertBefore(container, content);
    container.appendChild(toc);
    container.appendChild(content);

    // Êâ´ÊèèÊ†áÈ¢òÔºàÊîØÊåÅ h1-h3Ôºâ
    const headers = content.querySelectorAll("h1, h2, h3");
    const list = toc.querySelector("ul");

    headers.forEach(header => {
    const id = header.id || header.textContent.trim().toLowerCase().replace(/[^\w]+/g, "-");
    header.id = id; // Á°Æ‰øùÊúâ id

    const li = document.createElement("li");
    li.innerHTML = `<a href="#${id}">${header.textContent}</a>`;
    list.appendChild(li);
    });

    // Âπ≥ÊªëÊªöÂä®
    list.querySelectorAll("a").forEach(link => {
    link.addEventListener("click", e => {
        e.preventDefault();
        const target = document.querySelector(link.getAttribute("href"));
        if (target) {
        window.scrollTo({ top: target.offsetTop - 20, behavior: "smooth" });
        }
    });
    });

  // ÊªöÂä®È´ò‰∫ÆÂΩìÂâçÁ´†ËäÇ
    const links = list.querySelectorAll("a");
    const sections = Array.from(links).map(link => document.querySelector(link.getAttribute("href")));

    window.addEventListener("scroll", () => {
    const scrollPos = window.scrollY + 100;
    sections.forEach((sec, i) => {
        if (sec && sec.offsetTop <= scrollPos && sec.offsetTop + sec.offsetHeight > scrollPos) {
        links.forEach(l => l.classList.remove("active"));
        links[i].classList.add("active");
        }
    });
    });
});
</script>
</body>
</html>
